<!DOCTYPE html>
<!--
 Copyright (c) Microsoft Corporation.

 This source code is subject to terms and conditions of the Apache License, Version 2.0. A
 copy of the license can be found in the License.html file at the root of this distribution. If
 you cannot locate the Apache License, Version 2.0, please send an email to
 vspython@microsoft.com. By using this source code in any fashion, you are agreeing to be bound
 by the terms of the Apache License, Version 2.0.

 You must not remove this notice, or any other, from this software.
-->

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Python Worker Role Configuration</title>
    <style type="text/css">
        body {
            font-family: 'Segoe UI', Arial, Helvetica, sans-serif;
            font-weight: 200;
            font-size: 11pt;
        }

        p, h1, h2 {
            margin: 0;
            padding: 0;
        }

        h1 {
            font-size: 20pt;
            font-weight: bold;
            padding-top: 1em;
        }

            h1.top {
                padding-top: 0em;
            }

        h2 {
            font-size: 16pt;
            font-weight: 300;
            padding-top: 0.5em;
            padding-left: 0em;
        }

        p {
            padding-left: 0.5em;
            padding-bottom: 0.5em;
        }

        p.hint {
            color: #666666;
        }

        code {
            font-family: Consolas, 'Lucida Console', monospace;
        }

        ol {
            margin-top: 0;
            padding-top: 0;
        }

            ol > li {
                padding-top: 1.5em;
            }

        li > img {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <h1 class="top">One more thing...</h1>
    <div>
        <p>
            To finish configuring your woker role:
        </p>
        <ol>
            <li>Open your ServiceDefinition.csdef file: <img src="ServiceDefinition.png" /></li>
            <li>Find your new <code>&lt;workerrole role="{your project name}"&gt;</code> element.</li>
            <li>Copy and paste the XML below as a child of the <code>workerrole</code> element.</li>
        </ol>

        <textarea contenteditable="false" cols="75" rows="25" autofocus="autofocus">
&lt;startup&gt;
    &lt;task commandline="bin\ps.cmd ConfigureCloudService.ps1" executioncontext="elevated" tasktype="simple"&gt;
        &lt;environment&gt;
            &lt;variable name="EMULATED"&gt;
                &lt;roleinstancevalue xpath="/RoleEnvironment/Deployment/@emulated" /&gt;
            &lt;/variable&gt;
        &lt;/environment&gt;
    &lt;/task&gt;
&lt;/startup&gt;
&lt;runtime&gt;
    &lt;environment&gt;
        &lt;variable name="EMULATED"&gt;
            &lt;roleinstancevalue xpath="/RoleEnvironment/Deployment/@emulated" /&gt;
        &lt;/variable&gt;
    &lt;/environment&gt;
    &lt;entrypoint&gt;
        &lt;programentrypoint commandline="bin\ps.cmd LaunchWorker.ps1" setreadyonprocessstart="true" /&gt;
    &lt;/entrypoint&gt;
&lt;/runtime&gt;
        </textarea>
    </div>
    <p class="hint">This file may be deleted once your configuration has been updated.</p>

    <h1>Configuring Deployment</h1>

    <p>
        While the code above and the included PowerShell scripts may be edited
        freely, it is possible to set most configuration options through your
        Python project.
    </p>

    <p>
        To specify the version of Python your worker should run with, make it
        the active environment for your project. (Ensure that you have a WebPI
        reference or startup task to install this version on the instance - see
        the documentation in <code>ConfigureCloudService.ps1</code> for more
        details.)
    </p>

    <p>
        If your version of Python cannot be detected using the CPython registry
        keys after it has been installed, you can add the
        <code>DeployedPythonInterpreterPath</code> property to your Python
        project by editing the .pyproj file. This path will take precedence over
        the active environment.
    </p>

    <p>
        To install packages using pip, update the <code>requirements.txt</code>
        file in the root directory of your project.
    </p>

    <p>
        To set <code>PYTHONPATH</code> (or equivalent) before running the
        worker, add the necessary Search Paths to your project.
    </p>

    <p>To specify the script to run, make it the startup file in your project.</p>

    <p>
        To specify command-line arguments, add them to the Command Line
        Arguments property under Project Properties\Debug.
    </p>

    <h1>Troubleshooting Deployment</h1>

    <p>If your worker role does not behave correctly after deployment, check the following:</p>

    <ol>
        <li><p>Your Python project includes a bin\ folder with (at least):</p>
        <ul>
            <li><code>ConfigureCloudService.ps1</code></li>
            <li><code>LaunchWorker.ps1</code></li>
            <li><code>ps.cmd</code></li>
        </ul>
        </li>
        <li>Your Cloud project includes the above XML and the command lines match.</li>
        <li>Your Python project includes either:
            <ul>
                <li>a <code>requirements.txt</code> file listing all dependencies, OR</li>
                <li>a virtual environment containing all dependencies.</li>
            </ul>
            <p>
                <code>ConfigureCloudService.ps1</code> will not install 
                <code>requirements.txt</code> into a virtual environment (but you
                can modify the script to do this if you need it).
            </p>
        </li>
        <li>
            <p>
                Enable Remote Desktop on your Cloud Service and investigate the
                log files.
            </p>
            <p>
                Logs for <code>ConfigureCloudService.ps1</code> and
                <code>LaunchWorker.ps1</code> are stored in the following path
                on the machine instance:
            </p>
            <ul>
                <li><code>C:\Resources\Directory\%RoleId%.DiagnosticStore\LogFiles</code></li>
            </ul>
            <p>
                Currently, the <code>LaunchWorker.ps1</code> log is the only way
                to view output or errors displayed by your Python program.
            </p>
        </li>
        <li>
            Start a discussion at
            <a href="http://go.microsoft.com/fwlink/?LinkId=293415">our discussion forum</a>
            for further help.
        </li>
    </ol>
</body>
</html>