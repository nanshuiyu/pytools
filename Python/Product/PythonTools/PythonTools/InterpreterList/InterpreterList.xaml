<UserControl x:Class="Microsoft.PythonTools.InterpreterList.InterpreterList"
             x:ClassModifier="internal"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:s="clr-namespace:System;assembly=mscorlib"
             xmlns:ptvs="clr-namespace:Microsoft.PythonTools"
             xmlns:l="clr-namespace:Microsoft.PythonTools.InterpreterList"
             xmlns:wpf="clr-namespace:Microsoft.PythonTools.Wpf"
             xmlns:scm="clr-namespace:System.ComponentModel;assembly=WindowsBase"
             mc:Ignorable="d" 
             d:DesignHeight="400" d:DesignWidth="800"
             TextOptions.TextFormattingMode="Display"
             HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
             UseLayoutRounding="True"
             SnapsToDevicePixels="True"
             Background="{DynamicResource {x:Static wpf:Controls.BackgroundKey}}"
             TextElement.Foreground="{DynamicResource {x:Static wpf:Controls.ForegroundKey}}">
    <UserControl.InputBindings>
        <KeyBinding Key="F5" Command="{x:Static l:InterpreterList.RefreshCommand}" />
    </UserControl.InputBindings>

    <UserControl.CommandBindings>
        <CommandBinding Command="{x:Static l:InterpreterList.AbortCommand}" CanExecute="Abort_CanExecute" Executed="Abort_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.RegenerateCommand}" CanExecute="Regenerate_CanExecute" Executed="Regenerate_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.RefreshCommand}" CanExecute="Refresh_CanExecute" Executed="Refresh_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.OpenReplCommand}" CanExecute="OpenRepl_CanExecute" Executed="OpenRepl_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.OpenOptionsCommand}" CanExecute="OpenWindow_CanExecute" Executed="OpenWindow_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.OpenReplOptionsCommand}" CanExecute="OpenWindow_CanExecute" Executed="OpenWindow_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.OpenPathCommand}" CanExecute="OpenPath_CanExecute" Executed="OpenPath_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.MakeDefaultCommand}" CanExecute="MakeDefault_CanExecute" Executed="MakeDefault_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.CopyReasonCommand}" CanExecute="CopyReason_CanExecute" Executed="CopyReason_Executed" />
        <CommandBinding Command="{x:Static l:InterpreterList.WebChooseInterpreterCommand}" CanExecute="WebChooseInterpreter_CanExecute" Executed="WebChooseInterpreter_Executed" />
    </UserControl.CommandBindings>

    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Microsoft.PythonTools;component/Wpf/Controls.xaml" />

                <ResourceDictionary>
                    <Style x:Key="InterpreterItemStyle" TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <Border Background="{TemplateBinding Background}">
                                        <GridViewRowPresenter VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                                    </Border>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{DynamicResource {x:Static wpf:Controls.HotTrackKey}}" />
                            </Trigger>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter Property="Background" Value="{DynamicResource {x:Static wpf:Controls.HighlightKey}}" />
                            </Trigger>
                        </Style.Triggers>
                    </Style>

                    <Style x:Key="SubNameStyle" TargetType="Label" BasedOn="{StaticResource {x:Type Label}}">
                        <Setter Property="Margin" Value="6 1 1 1" />
                        <Setter Property="Foreground" Value="{DynamicResource {x:Static wpf:Controls.GrayTextKey}}" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsSelected,RelativeSource={RelativeSource AncestorType=ListViewItem}}"
                                         Value="True">
                                <Setter Property="Foreground" Value="{DynamicResource {x:Static wpf:Controls.BackgroundKey}}" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>

                    <DataTemplate x:Key="NameTemplate" DataType="{x:Type ptvs:InterpreterView}">
                        <StackPanel Orientation="Vertical" VerticalAlignment="Center">
                            <Grid>
                                <Label Name="InterpreterName"
                                       Padding="0"
                                       Content="{Binding Name}" />
                                <!-- Include a bold version of the name but
                                     hidden, so it participates in layout only.
                                     This will ensure there is room in the
                                     column for the bolded name if the user
                                     makes it bold. -->
                                <Label Padding="0"
                                       FontWeight="Bold"
                                       Visibility="Hidden"
                                       Content="{Binding Name}" />
                            </Grid>
                            <Label Name="InterpreterSubName"
                                   Padding="0"
                                   Style="{StaticResource SubNameStyle}"
                                   Content="{Binding SubName}" />
                        </StackPanel>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding IsDefault}" Value="True">
                                <Setter TargetName="InterpreterName" Property="FontWeight" Value="Bold" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding SubName}" Value="">
                                <Setter TargetName="InterpreterSubName" Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>

                    <DataTemplate x:Key="MakeDefaultTemplate" DataType="{x:Type ptvs:InterpreterView}">
                        <Button Name="MakeDefaultButton" Command="{x:Static l:InterpreterList.MakeDefaultCommand}" CommandParameter="{Binding}"
                                VerticalAlignment="Center">
                            Activate
                        </Button>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding Project}" Value="{x:Null}">
                                <Setter TargetName="MakeDefaultButton" Property="Content" Value="Make Default" />
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>
                    
                    <DataTemplate x:Key="DatabaseTemplate" DataType="{x:Type ptvs:InterpreterView}">
                        <Grid HorizontalAlignment="Stretch">
                            <Grid Name="Status" VerticalAlignment="Center" Margin="0 1">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="auto" />
                                </Grid.ColumnDefinitions>

                                <Grid Grid.Column="0" Margin="6 0">
                                    <Label Name="NotRequired" VerticalAlignment="Center" AutomationProperties.AutomationId="RegenerateNotRequired">
                                        Completion DB is up to date
                                    </Label>
                                    <StackPanel Name="Required" Orientation="Horizontal" Visibility="Hidden">
                                        <Label VerticalAlignment="Center" FontWeight="Bold" AutomationProperties.AutomationId="RegenerateRequired">
                                            Completion DB needs refresh
                                        </Label>
                                        <Expander Name="ShowContent"
                                                  Style="{StaticResource PopupExpander}"
                                                  HorizontalAlignment="Left" VerticalAlignment="Center">
                                            <Expander.Header>
                                                <Path Style="{StaticResource IconPath}"
                                                      Margin="1 0 0 0"
                                                      Data="F1M20.375,33.7956237792969L21.51171875,34.0221862792969 22.515625,34.7018737792969 23.1953125,35.6784362792969 23.421875,36.8581237792969 23.1953125,38.0260925292969 22.515625,38.9987487792969 21.50390625,39.6784362792969 20.375,39.9049987792969 19.234375,39.6745300292969 18.21875,38.9831237792969 17.5390625,38.0221862792969 17.3125,36.8581237792969 17.5390625,35.6706237792969 18.203125,34.7018737792969 19.22265625,34.0221862792969 20.375,33.7956237792969z M20.859375,4.82687377929688L24.5,5.31124877929688 27.515625,6.74874925613403 29.546875,9.10812377929688 30.28125,12.4049987792969 29.65625,15.5768737792969 28.953125,16.9128112792969 28.09375,18.1393737792969 27.1171875,19.2409362792969 26.0625,20.2174987792969 25.015625,21.1159362792969 24.046875,22.0143737792969 22.484375,23.8893737792969 21.859375,26.0456237792969 22.109375,27.8581237792969 22.3828125,28.6081237792969 22.640625,29.2331237792969 17.609375,29.2331237792969 17.3984375,28.5612487792969 17.21875,27.7174987792969 17.1015625,26.7956237792969 17.0625,25.8893737792969 17.640625,23.3268737792969 19.09375,21.1862487792969 20.015625,20.2018737792969 20.984375,19.2643737792969 21.96875,18.3424987792969 22.875,17.4518737792969 24.328125,15.5924987792969 24.921875,13.4674987792969 24.484375,11.6549987792969 23.296875,10.3424987792969 22.5,9.88937377929688 21.578125,9.57687377929688 20.5859375,9.38937377929688 19.515625,9.32687377929688 17.7509765625,9.51925659179688 16.03515625,10.0964050292969 14.3681631088257,11.0583200454712 12.75,12.4049987792969 12.75,7.06124877929688 16.7265625,5.38156127929688 20.859375,4.82687377929688z"/>
                                            </Expander.Header>
                                        </Expander>
                                    </StackPanel>
                                </Grid>
                                <Button Command="{x:Static l:InterpreterList.RegenerateCommand}" CommandParameter="{Binding}"
                                        Grid.Column="1">
                                    Refresh DB
                                </Button>
                            </Grid>
                            <Grid Name="Refreshing"
                                  Visibility="Collapsed"
                                  Margin="6 1"
                                  VerticalAlignment="Stretch"
                                  IsHitTestVisible="True"
                                  Background="Transparent"
                                  ToolTipService.ShowDuration="{x:Static s:Int32.MaxValue}">
                                <Grid.ToolTip>
                                    <ToolTip Content="{Binding Message,Mode=OneWay}"
                                             Placement="Bottom"
                                             PlacementTarget="{Binding ElementName=RefreshingDBLabel}"
                                             StaysOpen="True" />
                                </Grid.ToolTip>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="auto" />
                                    <RowDefinition Height="*" />
                                </Grid.RowDefinitions>
                                <Label Grid.Row="0" Name="RefreshingDBLabel" HorizontalAlignment="Center">
                                    Refreshing DB
                                </Label>
                                <ProgressBar Name="Progress"
                                             Grid.Row="1"
                                             Value="{Binding Progress,Mode=OneWay}"
                                             Minimum="0" Maximum="{Binding Maximum,Mode=OneWay}"
                                             IsIndeterminate="False"
                                             Margin="0 1"
                                             HorizontalAlignment="Stretch" VerticalAlignment="Stretch" />
                            </Grid>
                            <Grid Name="NoDatabase"
                                  Visibility="Collapsed"
                                  Margin="6 1"
                                  VerticalAlignment="Center">
                                <Label AutomationProperties.AutomationId="NoDatabase">
                                    Does not use a completion DB
                                </Label>
                            </Grid>
                            <Popup Name="Reason"
                                   IsOpen="{Binding IsExpanded,ElementName=ShowContent,Mode=TwoWay}"
                                   PlacementTarget="{Binding ElementName=Required}"
                                   Placement="Bottom"
                                   Width="auto"
                                   MaxWidth="640" MaxHeight="300"
                                   StaysOpen="False">
                                <Border Style="{StaticResource TooltipBorder}">
                                    <ScrollViewer Background="Transparent"
                                                  HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto"
                                                  Padding="2">
                                        <StackPanel Orientation="Horizontal">
                                            <Label Content="{Binding IsCurrentReason}"
                                                   Foreground="{Binding (TextElement.Foreground),RelativeSource={RelativeSource FindAncestor,AncestorType=Border}}"
                                                   VerticalAlignment="Center"/>
                                            <Button Command="{x:Static l:InterpreterList.CopyReasonCommand}"
                                                    CommandParameter="{Binding}"
                                                    FontFamily="Segoe UI Symbol"
                                                    Padding="2"
                                                    MinHeight="{Binding ActualWidth,RelativeSource={RelativeSource Self}}"
                                                    VerticalAlignment="Top">
                                                <Button.Content>
                                                    <Path Style="{StaticResource IconPath}"
                                                          Width="12" Height="12"
                                                          Data="F1M25.703125,15.4987487792969L25.703125,20.0768737792969 30.28125,20.0768737792969 25.703125,15.4987487792969z M16.5625,13.9831237792969L16.5625,33.7956237792969 31.8125,33.7956237792969 31.8125,23.1237487792969 22.65625,23.1237487792969 22.65625,13.9831237792969 16.5625,13.9831237792969z M8.921875,7.87374877929688L8.921875,27.7018737792969 13.515625,27.7018737792969 13.515625,10.9206237792969 18.078125,10.9206237792969 15.03125,7.87374877929688 8.921875,7.87374877929688z M5.890625,4.82687377929688L16.5625,4.82687377929688 22.65625,10.9206237792969 25.703125,10.9206237792969 34.859375,20.0768737792969 34.859375,36.8581237792969 13.515625,36.8581237792969 13.515625,30.7487487792969 5.890625,30.7487487792969 5.890625,4.82687377929688z" />
                                                </Button.Content>
                                                <Button.ToolTip>
                                                    Copy to Clipboard
                                                </Button.ToolTip>
                                            </Button>
                                        </StackPanel>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>
                        <DataTemplate.Triggers>
                            <DataTrigger Binding="{Binding CanRefresh,Mode=OneWay}" Value="false">
                                <Setter TargetName="Status" Property="Visibility" Value="Hidden" />
                                <Setter TargetName="Refreshing" Property="Visibility" Value="Hidden" />
                                <Setter TargetName="NoDatabase" Property="Visibility" Value="Visible" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsRunning,Mode=OneWay}" Value="true">
                                <Setter TargetName="Status" Property="Visibility" Value="Hidden" />
                                <Setter TargetName="Refreshing" Property="Visibility" Value="Visible" />
                                <Setter TargetName="NoDatabase" Property="Visibility" Value="Collapsed" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding Maximum,Mode=OneWay}" Value="0">
                                <Setter TargetName="Progress" Property="IsIndeterminate" Value="true" />
                            </DataTrigger>
                            <DataTrigger Binding="{Binding IsCurrent,Mode=OneWay}" Value="false">
                                <Setter TargetName="Required" Property="Visibility" Value="Visible" />
                                <Setter TargetName="NotRequired" Property="Visibility" Value="Hidden" />
                            </DataTrigger>
                        </DataTemplate.Triggers>
                    </DataTemplate>

                    <DataTemplate x:Key="OpenReplTemplate">
                        <Button Command="{x:Static l:InterpreterList.OpenReplCommand}" CommandParameter="{Binding}"
                                Style="{StaticResource NavigationButtonInList}"
                                VerticalAlignment="Center">
                            Interactive Window
                        </Button>
                    </DataTemplate>

                    <DataTemplate x:Key="OpenOptionsTemplate">
                        <StackPanel Orientation="Vertical" VerticalAlignment="Center">
                            <Button Command="{x:Static l:InterpreterList.OpenOptionsCommand}" CommandParameter="{Binding}"
                                    Margin="4 4 4 2"
                                    Style="{StaticResource NavigationButtonInList}">
                                Environment Options
                            </Button>
                            <Button Command="{x:Static l:InterpreterList.OpenReplOptionsCommand}" CommandParameter="{Binding}"
                                    Margin="4 2 4 4"
                                    Style="{StaticResource NavigationButtonInList}">
                                Interactive Options
                            </Button>
                        </StackPanel>
                    </DataTemplate>

                    <DataTemplate x:Key="OpenPathTemplate">
                        <Button Command="{x:Static l:InterpreterList.OpenPathCommand}" CommandParameter="{Binding}"
                                Style="{StaticResource NavigationButtonInList}"
                                VerticalAlignment="Center">
                            View in File Explorer
                        </Button>
                    </DataTemplate>
                </ResourceDictionary>
            </ResourceDictionary.MergedDictionaries>
        </ResourceDictionary>
    </UserControl.Resources>

    <Grid>
        <Grid.Resources>
            <wpf:IfElseConverter x:Key="BVConverter"
                                 IfTrue="{x:Static Visibility.Visible}"
                                 IfFalse="{x:Static Visibility.Collapsed}"/>
            <wpf:IfElseConverter x:Key="BCConverter"
                                 IfTrue="{x:Static Visibility.Collapsed}"
                                 IfFalse="{x:Static Visibility.Visible}"/>
        </Grid.Resources>
        <ListView x:Name="interpreterList"
                  AutomationProperties.AutomationId="PythonTools.InterpreterList"
                  HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                  ItemContainerStyle="{StaticResource InterpreterItemStyle}"
                  ItemsSource="{Binding Interpreters}"
                  Visibility="{Binding HasItems,RelativeSource={RelativeSource Self},Converter={StaticResource BVConverter}}">
            <ListView.Template>
                <ControlTemplate>
                    <ScrollViewer CanContentScroll="False">
                        <StackPanel Orientation="Vertical">
                            <ItemsPresenter />
                            <Grid Margin="6 12">
                                <Button Style="{StaticResource NavigationButton}"
                                        HorizontalAlignment="Left"
                                        Command="{x:Static l:InterpreterList.WebChooseInterpreterCommand}">
                                    Go online and help me find another environment
                                </Button>
                            </Grid>
                        </StackPanel>
                    </ScrollViewer>
                </ControlTemplate>
            </ListView.Template>
            <ListView.View>
                <GridView AllowsColumnReorder="False">
                    <GridViewColumn CellTemplate="{StaticResource NameTemplate}" x:Name="nameColumn" />
                    <GridViewColumn CellTemplate="{StaticResource OpenReplTemplate}" />
                    <GridViewColumn CellTemplate="{StaticResource MakeDefaultTemplate}" />
                    <GridViewColumn CellTemplate="{StaticResource OpenOptionsTemplate}" />
                    <GridViewColumn CellTemplate="{StaticResource DatabaseTemplate}" />
                    <GridViewColumn CellTemplate="{StaticResource OpenPathTemplate}" />
                </GridView>
            </ListView.View>
        </ListView>
        
        <StackPanel Orientation="Vertical"
                    HorizontalAlignment="Center" VerticalAlignment="Center"
                    Visibility="{Binding HasItems,ElementName=interpreterList,Converter={StaticResource BCConverter}}">
            <TextBlock HorizontalAlignment="Center"
                       Margin="6">
                We didn't find any Python environments
            </TextBlock>
            <Button Style="{StaticResource NavigationButton}"
                    HorizontalAlignment="Center"
                    Margin="6"
                    Command="{x:Static l:InterpreterList.WebChooseInterpreterCommand}">
                Go online and help me choose one
            </Button>
            <Button Style="{StaticResource NavigationButton}"
                    HorizontalAlignment="Center"
                    Margin="6"
                    Command="{x:Static l:InterpreterList.OpenOptionsCommand}">
                Open Environment Options and add one
            </Button>
        </StackPanel>
    </Grid>
</UserControl>
